name: SISR Build Base

on:
    workflow_call:
        inputs:
            artifact_suffix:
                required: false
                type: string
                default: ""
                description: "Suffix to add to artifact names"
            upload_artifacts:
                required: false
                type: boolean
                default: false
                description: "Whether to upload build artifacts"

jobs:
    test:
        name: Test
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, windows-latest]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25"
                  cache: "pnpm"
                  cache-dependency-path: cef_injectee/pnpm-lock.yaml

            - name: Install cef_injectee dependencies
              working-directory: cef_injectee
              run: pnpm install

            - name: Build cef_injectee
              working-directory: cef_injectee
              run: pnpm run build

            - name: Cache Rust dependencies
              uses: Swatinem/rust-cache@v2

            - name: Install build dependencies (Ubuntu)
              if: matrix.os == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y ninja-build cmake pkg-config libgtk-3-dev libxdo-dev

            - name: Install build tools (Windows)
              if: matrix.os == 'windows-latest'
              shell: pwsh
              run: |
                  choco install ninja cmake -y
                  ninja --version
                  cmake --version

            - name: Run tests
              run: cargo test --all-features

    build:
        name: Build binaries (${{ matrix.target.name }})
        runs-on: ${{ matrix.target.os }}
        strategy:
            fail-fast: false
            matrix:
                target:
                    - {
                          name: "x86_64-windows-msvc",
                          os: "windows-latest",
                          ext: ".exe",
                          rust_target: "x86_64-pc-windows-msvc",
                          cross: false,
                      }
                    - {
                          name: "aarch64-windows-msvc",
                          os: "windows-latest",
                          ext: ".exe",
                          rust_target: "aarch64-pc-windows-msvc",
                          cross: true,
                      }
                    - {
                          name: "x86_64-linux",
                          os: "ubuntu-latest",
                          ext: "",
                          rust_target: "x86_64-unknown-linux-gnu",
                          cross: false,
                      }
                    - {
                          name: "aarch64-linux",
                          os: "ubuntu-24.04-arm",
                          ext: "",
                          rust_target: "aarch64-unknown-linux-gnu",
                          cross: false,
                      }
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target.rust_target }}

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "25"
                  cache: "pnpm"
                  cache-dependency-path: cef_injectee/pnpm-lock.yaml

            - name: Install cef_injectee dependencies
              working-directory: cef_injectee
              run: pnpm install

            - name: Build cef_injectee
              working-directory: cef_injectee
              run: pnpm run build

            - name: Cache Rust dependencies
              uses: Swatinem/rust-cache@v2
              with:
                  key: ${{ matrix.target.rust_target }}

            - name: Install build dependencies (Ubuntu)
              if: matrix.target.os == 'ubuntu-latest' || matrix.target.os == 'ubuntu-24.04-arm'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y ninja-build cmake pkg-config libgtk-3-dev libxdo-dev

            - name: Install build tools (Windows)
              if: matrix.target.os == 'windows-latest'
              shell: pwsh
              run: |
                  choco install ninja cmake -y
                  ninja --version
                  cmake --version

            - name: Calculate version
              id: version
              shell: bash
              run: |
                  VERSION=$(git describe --tags --match "v[0-9]*.[0-9]*.[0-9]*" --always || echo "v0.0.0-dev")
                  git fetch --tags --force || true
                  if ! echo "$VERSION" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+'; then
                    COMMIT_COUNT=$(git rev-list --count HEAD)
                    VERSION="v0.0.0-${COMMIT_COUNT}-${GITHUB_SHA:0:7}"
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Version: $VERSION"

            - name: Build
              shell: bash
              env:
                  SISR_VERSION: ${{ steps.version.outputs.version }}
              run: |
                  mkdir -p dist/package
                  cargo build --release --target ${{ matrix.target.rust_target }}

                  cp target/${{ matrix.target.rust_target }}/release/SISR${{ matrix.target.ext }} dist/package/SISR${{ matrix.target.ext }}

                  if [ "${{ matrix.target.os }}" = "windows-latest" ]; then
                    SDL3_DLL=$(find target/${{ matrix.target.rust_target }}/release/build/sdl3-sys-*/out/build -name "SDL3.dll" | head -1)
                    if [ -f "$SDL3_DLL" ]; then
                      cp "$SDL3_DLL" dist/package/
                      echo "Copied SDL3.dll"
                    else
                      echo "Warning: SDL3.dll not found"
                    fi
                  else
                    SDL3_SO=$(find target/${{ matrix.target.rust_target }}/release/build/sdl3-sys-*/out/build -name "libSDL3.so*" | head -1)
                    if [ -f "$SDL3_SO" ]; then
                      cp -P "$SDL3_SO"* dist/package/ 2>/dev/null || cp "$SDL3_SO" dist/package/
                      rm -f target/${{ matrix.target.rust_target }}/release/libSDL3.so.0
                      cp "$SDL3_SO" target/${{ matrix.target.rust_target }}/release/libSDL3.so.0
                      echo "Copied SDL3 library"
                    else
                      echo "Warning: SDL3 library not found"
                    fi
                  fi

                  # Include VIIPER server binary
                  if [ "${{ matrix.target.os }}" = "windows-latest" ]; then
                    CANDIDATE1="target/${{ matrix.target.rust_target }}/release/viiper${{ matrix.target.ext }}"
                    CANDIDATE2="target/release/viiper${{ matrix.target.ext }}"
                  else
                    CANDIDATE1="target/${{ matrix.target.rust_target }}/release/viiper"
                    CANDIDATE2="target/release/viiper"
                  fi

                  if [ -f "$CANDIDATE1" ]; then
                    cp "$CANDIDATE1" dist/package/
                    echo "Included VIIPER binary from $CANDIDATE1"
                  elif [ -f "$CANDIDATE2" ]; then
                    cp "$CANDIDATE2" dist/package/
                    echo "Included VIIPER binary from $CANDIDATE2"
                  fi

                  ls -la dist/package

            - name: Build AppImage
              if: startsWith(matrix.target.name, 'aarch64-linux') || startsWith(matrix.target.name, 'x86_64-linux')
              shell: bash
              run: |
                  ARCH=$(uname -m)
                  curl -fsSL "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-${ARCH}.AppImage" -o linuxdeploy
                  chmod +x linuxdeploy
                  rm -rf AppDir
                  export LD_LIBRARY_PATH="target/${{ matrix.target.rust_target }}/release:$LD_LIBRARY_PATH"
                  export LINUXDEPLOY_EXCLUDED_LIBRARIES="libxkbcommon.so*;libxkbcommon-x11.so*;libwayland-client.so*;libwayland-cursor.so*;libwayland-egl.so*"
                  NO_STRIP=1 ./linuxdeploy --appdir AppDir -l target/${{ matrix.target.rust_target }}/release/libSDL3.so.0 -e target/${{ matrix.target.rust_target }}/release/SISR -d sisr.desktop -i docs/SISR.svg --output appimage
                  mkdir -p dist/appimage
                  mv SISR-${ARCH}.AppImage dist/appimage/

            - name: Create archive
              shell: bash
              run: |
                  cd dist
                  if [ "${{ matrix.target.os }}" = "windows-latest" ]; then
                    7z a -tzip "SISR-${{ matrix.target.name }}${{ inputs.artifact_suffix }}.zip" ./package/*
                  else
                    tar -czf "SISR-${{ matrix.target.name }}${{ inputs.artifact_suffix }}.tar.gz" -C package .
                  fi
                  cd ..

            - name: Upload artifact
              if: ${{ inputs.upload_artifacts }}
              uses: actions/upload-artifact@v4
              with:
                  name: SISR-${{ matrix.target.name }}${{ inputs.artifact_suffix }}
                  path: |
                      dist/*.zip
                      dist/*.tar.gz
                  if-no-files-found: warn

            - name: Upload AppImage artifact
              if: ${{ inputs.upload_artifacts && (startsWith(matrix.target.name, 'aarch64-linux') || startsWith(matrix.target.name, 'x86_64-linux')) }}
              uses: actions/upload-artifact@v4
              with:
                  name: SISR-${{ matrix.target.name }}-AppImage${{ inputs.artifact_suffix }}
                  path: dist/appimage/*.AppImage
                  if-no-files-found: warn
